---
description: ai-camera 代码审计规则，覆盖架构边界、安全隐私、实时链路、可靠性、成本与可维护性。
---

# ai-camera 代码审计规则

**视角：你（开发/评审者）必须遵守**  
**目的：** 以风险为导向，确保实时相机产品在安全、隐私、稳定、性能与成本方面可控。

## 1. 适用范围

- iOS 端（相机管线、实时渲染、TTS/提示系统、网络与降级）
- 后端（FastAPI、WebSocket、鉴权、配置/运营后台接口）
- 基础设施（Docker、部署暴露面、密钥管理、日志/监控）

## 2. 规则等级

- **P0 / Critical**：安全合规、隐私泄露、主流程不可用、不可恢复的数据损坏、账号/订阅被绕过。
- **P1 / High**：实时体验严重劣化（高延迟/抖动）、成本不可控、风控缺失、稳定性高风险。
- **P2 / Medium**：结构性技术债、较高维护成本、可测试性缺失、可观测性不足。
- **P3 / Low**：命名、格式、轻度重复等风格类问题。

## 3. 文件规模不是强制红线

- 不得仅以行数做结论；必须结合复杂度、耦合、变更频率、测试覆盖与事故历史综合判断。

## 4. 必须检查的风险域

### 4.1 架构边界与依赖

- **P0**：跨层直接访问（UI 直接做网络协议/鉴权/持久化；API handler 承载大量业务策略）。
- **P1**：核心逻辑与基础设施强耦合（无法替换推理服务、无法切换传输协议）。
- **P2**：隐式全局状态扩散、循环依赖、缺少清晰接口契约。

### 4.2 安全与鉴权

- **P0**：公开暴露可“铸币”的 token 接口；服务端信任客户端传入的身份字段来授权。
- **P1**：缺少 rate limit / anti-abuse；管理员后台无审计/无 2FA。

### 4.3 隐私与合规（相机帧/生物特征）

- **P0**：上传/存储原始帧未明示；日志/监控里出现原始图片、可识别的人脸/骨架与用户标识绑定。
- **P1**：缺少“仅端侧模式/降级模式”的清晰开关与说明；数据保留策略不清晰。

### 4.4 实时链路（延迟、抖动、节流）

- **P0**：无超时/无 backpressure 导致 UI 卡死或队列堆积。
- **P1**：提示抖动严重（频繁反复指令）；无冷却/无趋势判断；弱网时无降级。
- **P1**：WebSocket 重连/断线处理不健壮，导致“假连接”或资源泄露。

### 4.5 成本与容量

- **P1**：帧率/分辨率无上限；单用户/单会话可打爆推理与带宽成本。
- **P2**：缺少成本指标埋点（fps、上传字节、推理耗时、降级率）。

### 4.6 可靠性与可观测性

- **P0**：核心服务无降级策略；断网时阻塞取景/拍照。
- **P1**：错误吞异常；无关键告警；无 trace/session 关联。
- **P2**：缺少关键体验指标的可测量闭环（延迟分桶、采纳率、OK-to-shoot 稳定性）。

### 4.7 质量与可测试性

- **P1**：关键逻辑无法单测，只能靠手工或端到端覆盖。
- **P2**：无回归基线；协议与 schema 无版本兼容策略。

## 5. 证据与输出要求

审计输出必须包含：

- 代码位置（文件路径 + 关键片段/接口）
- 触发条件/场景（弱网、夜景、频繁切前后摄、后台切换云端开关等）
- 风险说明与影响范围（用户、数据、成本、合规）
- 建议修复方案（短期止血 + 中期重构 + 长期演进）

